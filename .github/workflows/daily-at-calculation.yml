name: Daily Adaptive Thermogenesis Calculation

on:
  # Run daily at 02:00 UTC (03:00 CET)
  schedule:
    - cron: '0 2 * * *'

  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  calculate-at:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy Edge Function
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          supabase functions deploy calculate-adaptive-thermogenesis \
            --project-ref $SUPABASE_PROJECT_ID

      - name: Trigger AT Calculation
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          curl -i --fail-with-body \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "Content-Type: application/json" \
            "$SUPABASE_URL/functions/v1/calculate-adaptive-thermogenesis"
